<!DOCTYPE html>
<html lang="es">
<head>
	<!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<title>WebSocket</title>
	<!--<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">-->
	<link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
</head>
<body>
	<main id="app" style="text-align: center !important" class="container">
		<div>
			<h2>WEB-SOCKET <h3>Developer test</h3></h2>
		</div>
		<br>
		<div>
			<label>Url Web Sockket</label>
			<input v-model="url" type="" name="" placeholder="url del web socket">
			<input v-model="username" type="" name="" placeholder="Tu Usuario">
			<button @click="conectar()">Conectar</button>
		</div>
		<hr>
		<div>
			<label>Canal de Transmisi贸n</label>
			<input v-model="channel" type="" name="" placeholder="Pegue el canal de transmisi贸n">
		</div>
		<div>
			<label>Mensaje: </label>
			<textarea v-model="mensaje" placeholder="escriba su mensaje" style="vertical-align: middle;"></textarea>
			<button @click="transmitir()"> Enviar </button>
		</div>
		<hr>
		<div class="row">
			<div class="col-6">
				<div class="card bg-light mb-3" style="max-width: 18rem;">
				  <div class="card-header">Configuraci贸n</div>
				  <div class="card-body">
				    <h5 class="card-title">Detalle</h5>
				    <p class="card-text">
				    	<span class="small font-weight-bold">Host</span>: <span class="text-muted small">{{ url }}</span>
				    </p>
				    <p class="card-text" v-if="channel.length > 0">
				    	<span class="small font-weight-bold">Channel</span>: <span class="text-muted small">{{ channel }}</span>
				    </p>
				    <p class="card-text">
				    	<span class="small font-weight-bold">Status</span>: <span class="small badge badge-success">Conected</span>
				    </p>
				  </div>
				</div>
				<!--<div>
					<h3>Configuraci贸n</h3>
					<pre>{{ $data }}</pre>
				</div>-->
			</div>
			<div class="col-6">
				<div v-if="mensajes.length > 0">
					<h3>Mensajes</h3>
					<div v-for="mensaje in mensajes">
						<div class="alert alert-success" role="alert">
						  <h4 class="alert-heading">{{ mensaje.username }}</h4>
						  <p>...</p>
						  <hr>
						  <p class="mb-0">{{ mensaje.message }}</p>
						</div>
						<!-- <div class="alert alert-info">{{ mensaje.message }}</div> -->
					</div>
				</div>
			</div>
		</div>
	</main>


	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
	<script type="text/javascript">
		
		var v = new Vue({
			el: "#app",
			data: {
				url: "ws://localhost:8004/websocket",
				channel: "",
				mensaje: "",
				username: "",
				channelDestination:"",
				mensajes: [],
				socket: null
			},
			methods: {
				conectar(){
					this.channel = this.generateUUID;
					if(this.socket == null){
						this.socket = new WebSocket(this.url);
				        let stompClient = Stomp.over(this.socket);
				        let instance = this;
				        stompClient.debug = () => {};
				        stompClient.connect({}, ( frame ) => {
				            stompClient.subscribe('/topic/notification/' + instance.channel, ( messageOutput ) => {
				            	instance.mensajes.push(JSON.parse(messageOutput.body));
				            });
				        });
				        console.log("Conectado al ws correctamente..");
				        alert("Conectado al ws correctamente..");
					}else{
						alert("ya esta conectado..");
					}
				},
				transmitir(){
					let socket = new WebSocket(this.url);
			        let stompClient = Stomp.over(socket);
			        let instance = this;
			        let dataJson = {
			        	username: instance.username,
			        	message: instance.mensaje
			        }
			        stompClient.debug = () => {};
			        stompClient.connect({}, ( frame ) => {
			            stompClient.send("/app/notification/" + instance.channelDestination, {},JSON.stringify(dataJson));
			            (stompClient != null) ? stompClient.disconnect() : console.log('Not Disconnected');
			        });
				}
			},
			computed:{
				generateUUID(){
				    var dt = new Date().getTime();
				    var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
				        var r = (dt + Math.random()*16)%16 | 0;
				        dt = Math.floor(dt/16);
				        return (c=='x' ? r :(r&0x3|0x8)).toString(16);
				    });
				    return uuid;
				}
			}

		});
	</script>
</body>
</html>